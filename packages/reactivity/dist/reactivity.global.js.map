{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/efftect.ts","../src/reactive.ts","../src/computed.ts"],"sourcesContent":["export function is_object(value: unknown) {\n return typeof value === 'object' && value != null\n}\n\nexport function is_function (value:unknown) {\n  return typeof value === 'function'\n}","\n\n//全局的 effect 调用栈 和 当前effect\nlet active_effect: ReactiveEffect | undefined\nlet effect_stack:[] = []\n\n\nexport class ReactiveEffect<T = any> {\n  public active = true\n  deps:Set<ReactiveEffect>[] = []\n\n  constructor(public fn: () => T, public scheduler?){}\n  //运行\n  run(){\n    if (!this.active) {\n      return this.fn()\n    }\n    if(!effect_stack.includes(this as never)) {\n      try {\n        effect_stack.push(active_effect = this as never)\n        return this.fn() //执行fn的时候，会触发取值 get\n      } finally {\n        effect_stack.pop()\n        active_effect = effect_stack[effect_stack.length -1]\n      }\n    }\n  }\n  //停止\n  stop(){\n    if (!this.active) {\n      return\n    }\n    cleanup_effect(this)\n    this.active = false\n  }\n}\n\n//清空\nfunction cleanup_effect(effect: ReactiveEffect) {\n  const { deps } = effect\n  for (const dep of deps) {\n    dep.delete(effect)\n  }\n}\n\nconst target_map = new WeakMap()\n\n//依赖收集\n// WeakMap = { 对象(target): Map{ 属性：Set[ effect ] } }\nexport function track (target:{}, key:unknown) {\n  if (!is_tracking()) {\n    return\n  }\n  let deps_map = target_map.get(target)\n  if(!deps_map) {\n    target_map.set(target, deps_map = new Map())\n  }\n  let dep = deps_map.get(key)\n  if (!dep) {\n    deps_map.set(key, (dep = new Set()))\n  }\n  track_effect(dep)\n}\n//收集属性\nexport function track_effect(dep){\n  let should_track = !dep.has(active_effect)\n  if (should_track) {\n    dep.add(active_effect) //一个属性对应多个 effect\n    active_effect?.deps.push(dep as never) //一个 effect 对应多个属性\n  }\n}\n// 是否进行收集 （只收集在 effect函数中的变量）\nexport function is_tracking () {\n  return active_effect !== undefined\n}\n\n//触发更新\nexport function trigger (target:{}, key:unknown) {\n  let deps_map = target_map.get(target)\n  if (!deps_map) {\n    return\n  }\n  let deps = []\n  if(key !== undefined) {\n    deps.push(deps_map.get(key))\n  }\n  let effects = []\n  for (const dep of deps) {\n    effects.push(...dep)\n  }\n  trigger_effects(effects)\n}\n\n//触发 effects 执行\nexport function trigger_effects (effects) {\n  for (const effect of effects) {\n    if(effect !== active_effect) { //防止循环\n      //设置值的时候 不触发 computed effect 的 get了，改为执行 scheduler\n      if (effect.scheduler) {\n        return effect.scheduler()\n      }\n      effect.run()\n    }\n  }\n}\n\nexport interface ReactiveEffectRunner<T = any> {\n  (): T\n  effect: ReactiveEffect\n}\n\nexport function effect<T = any> (fn:() => T):ReactiveEffectRunner {\n  const _effect = new ReactiveEffect(fn)\n  _effect.run()\n  let runner = _effect.run.bind(_effect) as ReactiveEffectRunner\n  runner.effect = _effect\n  return runner\n}","import { is_object } from \"@vue/shared\";\nimport { track, trigger } from \"./efftect\";\n\nconst enum REACTIVE_FLAGS {\n  IS_REACTIVE = '__v_isReactive'\n}\n\nconst proxy_handler:ProxyHandler<object> = {\n  get(target, key, recevier){\n    // 已经代理过的对象不需要重复代理\n    if(key === REACTIVE_FLAGS.IS_REACTIVE) {\n      return true\n    }\n    //依赖收集\n    track(target, key)\n    return Reflect.get(target, key, recevier)\n  },\n  set(target, key, value, recevier){\n    let old_value = (target as any)[key] //先取老值 顺序很重要\n    let res = Reflect.set(target, key, value, recevier)//先设置值的变化，再触发更新\n    if(old_value !== value) {\n      //触发更新\n      trigger(target, key)\n    }\n    return res\n  },\n}\n\n// 缓存 对同一个对象 重复 reactive，是相等的\nconst reactive_map = new WeakMap()\n\nfunction create_reactive_object(target: object){\n  if (!is_object(target)) return target\n\n  if((target as any)[REACTIVE_FLAGS.IS_REACTIVE]) {\n    return target\n  }\n\n  const existing_proxy = reactive_map.get(target)\n  if(existing_proxy) {\n    return existing_proxy\n  }\n\n  const proxy = new Proxy(target, proxy_handler)\n  reactive_map.set(target, proxy)\n  return proxy\n}\n\nexport function reactive (target: object) {\n  return create_reactive_object(target)\n}\n\n\n/* let state = {\n  count: 1,\n  get alias (){\n    return this.count\n  }\n}\n\nconst proxy = new Proxy(state, {\n  get: function(target, key, recevier){\n    console.log('key', key)\n    return target[key]\n  },\n})\n\nproxy.alias */\n\n","import { is_function } from \"@vue/shared\";\nimport { is_tracking, ReactiveEffect, track_effect, trigger_effects } from \"./efftect\";\n\n\nclass ComputedRefImpl<T> {\n  public dep;\n  public _value !: T\n  public _dirty = true\n  public readonly effect: ReactiveEffect<T>\n  public readonly __v_isRef = true\n\n  constructor(getter, private readonly _setter){\n    this.effect = new ReactiveEffect(getter, () => {\n      // 在 scheduler 中将 _dirty 重置为 true，并且触发 计算属性 相关的 effect 执行\n      if (!this._dirty) {\n        this._dirty = true\n        trigger_effects(this.dep)\n      }\n    })\n  }\n\n  get value(){\n    if (is_tracking()) {\n      track_effect(this.dep || (this.dep = new Set()))\n    }\n    if (this._dirty) {\n      console.log('ComputedRefImpl get')\n      this._value = this.effect.run()\n      this._dirty = false\n    }\n    console.log('this _value', this._value)\n    return this._value\n  }\n  set value(new_value){\n    this._setter(new_value)\n  }\n}\n\n\nexport function computed (getter_or_options) {\n  const only_getter = is_function(getter_or_options)\n  let getter\n  let setter\n  if(only_getter){\n    getter = getter_or_options\n    setter = () => {}\n  } else {\n    getter = getter_or_options.get\n    setter = getter_or_options.set\n  }\n  return new ComputedRefImpl(getter, setter)\n}\n\n"],"names":[],"mappings":"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"}