{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/efftect.ts","../src/reactive.ts"],"sourcesContent":["export function isObject(value: unknown) {\n return typeof value === 'object' && value != null\n}","\n\n//全局的 effect 调用栈 和 当前effect\nlet active_effect: ReactiveEffect | undefined\nlet effect_stack:[] = []\n\n\nclass ReactiveEffect<T = any> {\n  active = true\n  deps:Set<ReactiveEffect>[] = []\n  constructor(public fn: () => T){\n\n  }\n  //运行\n  run(){\n    if (!this.active) {\n      return this.fn()\n    }\n    if(!effect_stack.includes(this as never)) {\n      try {\n        effect_stack.push(active_effect = this as never)\n        this.fn() //执行fn的时候，会触发取值 get\n      } finally {\n        effect_stack.pop()\n        active_effect = effect_stack[effect_stack.length -1]\n      }\n    }\n  }\n  //停止\n  stop(){\n    if (!this.active) {\n      return\n    }\n    cleanup_effect(this)\n    this.active = false\n  }\n}\n\n//清空\nfunction cleanup_effect(effect: ReactiveEffect) {\n  const { deps } = effect\n  for (const dep of deps) {\n    dep.delete(effect)\n  }\n}\n\nconst target_map = new WeakMap()\n//依赖收集\nexport function track (target:{}, key:unknown) {\n  if (!is_tracking()) {\n    return\n  }\n  let deps_map = target_map.get(target)\n  if(!deps_map) {\n    target_map.set(target, deps_map = new Map())\n  }\n  let dep = deps_map.get(key)\n  if (!dep) {\n    deps_map.set(key, (dep = new Set()))\n  }\n  let should_track = !dep.has(active_effect)\n  if (should_track) {\n    dep.add(active_effect) //一个属性对应多个 effect\n    active_effect?.deps.push(dep as never) //一个 effect 对应多个属性\n  }\n}\n// 是否进行收集 （只收集在 effect函数中的变量）\nexport function is_tracking () {\n  return active_effect !== undefined\n}\n\n//触发更新\nexport function trigger (target:{}, key:unknown) {\n  let deps_map = target_map.get(target)\n  if (!deps_map) {\n    return\n  }\n  let deps = []\n  if(key !== undefined) {\n    deps.push(deps_map.get(key))\n  }\n  let effects = []\n  for (const dep of deps) {\n    effects.push(...dep)\n  }\n  for (const effect of effects) {\n    if(effect !== active_effect) { //防止循环\n      effect.run()\n    }\n  }\n}\n\nexport interface ReactiveEffectRunner<T = any> {\n  (): T\n  effect: ReactiveEffect\n}\n\nexport function effect<T = any> (fn:() => T):ReactiveEffectRunner {\n  const _effect = new ReactiveEffect(fn)\n  _effect.run()\n  let runner = _effect.run.bind(_effect) as ReactiveEffectRunner\n  runner.effect = _effect\n  return runner\n}","import { isObject } from \"@vue/shared\";\nimport { track, trigger } from \"./efftect\";\n\nconst enum REACTIVE_FLAGS {\n  IS_REACTIVE = '__v_isReactive'\n}\n\nconst proxy_handler:ProxyHandler<object> = {\n  get(target, key, recevier){\n    // 已经代理过的对象不需要重复代理\n    if(key === REACTIVE_FLAGS.IS_REACTIVE) {\n      return true\n    }\n    //依赖收集\n    track(target, key)\n    return Reflect.get(target, key, recevier)\n  },\n  set(target, key, value, recevier){\n    let old_value = (target as any)[key] //先取老值 顺序很重要\n    let res = Reflect.set(target, key, value, recevier)//先设置值的变化，再触发更新\n    if(old_value !== value) {\n      //触发更新\n      trigger(target, key)\n    }\n    return res\n  },\n}\n\n// 缓存 对同一个对象 重复 reactive，是相等的\nconst reactive_map = new WeakMap()\n\nfunction create_reactive_object(target: object){\n  if (!isObject(target)) return target\n\n  if((target as any)[REACTIVE_FLAGS.IS_REACTIVE]) {\n    return target\n  }\n\n  const existing_proxy = reactive_map.get(target)\n  if(existing_proxy) {\n    return existing_proxy\n  }\n\n  const proxy = new Proxy(target, proxy_handler)\n  reactive_map.set(target, proxy)\n  return proxy\n}\n\nexport function reactive (target: object) {\n  return create_reactive_object(target)\n}\n\n"],"names":[],"mappings":"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"}